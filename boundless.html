```
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— é™ä¹‹æ—… çŠ¶æ€</title>
    <style>
        :root {
            --primary: #4f6ef7;
            --accent-rose: #ff6b9d;
            --accent-teal: #4ecdc4;
            --accent-lilac: #a29bfe;
            --surface: #f9f9fd;
            --surface-strong: #ffffff;
            --border: rgba(79, 110, 247, 0.12);
            --text-main: #2f3545;
            --text-muted: #6f7390;
            --danger: #f44336;
            --warning: #ff9800;
        }
        :root[data-theme="dark"] {
            --primary: #7a8fff;
            --accent-rose: #ff7ba8;
            --accent-teal: #5eddd6;
            --accent-lilac: #b5a9ff;
            --surface: #2d3142;
            --surface-strong: #3a3e52;
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #d4d8e8;
            --text-muted: #9ca0b4;
            --danger: #ff6b6b;
            --warning: #ffb74d;
        }
        :root[data-theme="dark"] [style*="#e3e6f5"],
        :root[data-theme="dark"] [style*="#e1e5f2"] {
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
        :root[data-theme="dark"] .status-card {
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
        }
        :root[data-theme="dark"] .empty-tip {
            color: var(--text-muted);
        }
        :root[data-theme="dark"] .error-tip {
            background: rgba(255, 82, 82, 0.15);
            border-color: rgba(255, 82, 82, 0.3);
            color: #ff6b6b;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Microsoft YaHei", "PingFang SC", "Hiragino Sans GB","Noto Sans CJK SC", sans-serif;
            background: transparent;
            color: var(--text-main);
            padding: 10px;
        }
        .status-card {
            max-width: 960px;
            margin: 0 auto;
            background: var(--surface-strong);
            border-radius: 14px;
            border: 1px solid var(--border);
            box-shadow: 0 18px 40px rgba(79, 110, 247, 0.12);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        :root[data-theme="dark"] .status-card {
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
        }
        .status-header {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            position: relative;
        }
        .status-title {
            flex: 1;
        }
        .status-title h1 {
            font-size: 1.4rem;
            font-weight: 900;
            letter-spacing: 0.04em;
        }
        .status-subtitle {
            margin-top: 3px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-muted);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        .theme-toggle:hover {
            background: var(--surface-strong);
            color: var(--primary);
            border-color: var(--primary);
        }
        .status-meta {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        .meta-item {
            background: var(--surface);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 5px 7px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .meta-label {
            font-size: 0.65rem;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .meta-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-main);
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.2;
        }
        #world-coordinate {
            max-width: 100%;
            white-space: normal;
            display: block;
        }
        .meta-value.danger {
            color: var(--danger);
        }
        .tab-strip {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .tab-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 6px;
        }
        .tab-button {
            width: 100%;
            border: none;
            background: var(--surface);
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tab-button:hover {
            color: var(--primary);
            background: var(--surface-strong);
            border-color: var(--primary);
        }
        .tab-button.active {
            background: var(--surface-strong);
            color: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(79, 110, 247, 0.15);
        }
        :root[data-theme="dark"] .tab-button:hover {
            background: rgba(122, 143, 255, 0.15);
            border-color: rgba(122, 143, 255, 0.4);
        }
        :root[data-theme="dark"] .tab-button.active {
            box-shadow: 0 2px 8px rgba(122, 143, 255, 0.2);
        }
        .tab-button::after {
            content: 'â–¼';
            font-size: 0.7rem;
            transition: transform 0.2s ease;
        }
        .tab-button.active::after {
            transform: rotate(180deg);
        }
        .tab-panel {
            display: none;
            flex-direction: column;
            gap: 8px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease, margin 0.3s ease;
            padding: 0;
            margin: 0;
        }
        .tab-panel.active {
            display: flex;
            max-height: 5000px;
            padding-top: 8px;
            margin-top: 6px;
        }
        .panel-block {
            background: var(--surface);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .panel-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: 0.04em;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 6px;
        }
        .info-card {
            background: var(--surface-strong);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 6px 8px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-height: fit-content;
        }
        .info-label {
            font-size: 0.72rem;
            color: var(--text-muted);
            letter-spacing: 0.06em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .info-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            word-break: break-word;
            line-height: 1.3;
        }
        .metric-card {
            background: var(--surface-strong);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 6px 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .metric-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .metric-value {
            display: flex;
            align-items: baseline;
            gap: 5px;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary);
        }
        .metric-value span {
            display: inline-flex;
        }
        .metric-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 400;
        }
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #e4e7f5;
            border-radius: 999px;
            overflow: hidden;
        }
        .progress-bar-value {
            height: 100%;
            background: var(--primary);
            transition: width 0.4s ease;
            border-radius: 999px;
        }
        .text-group {
            display: grid;
            gap: 6px;
        }
        .text-item {
            background: var(--surface-strong);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .info-text {
            color: var(--text-main);
            line-height: 1.5;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .task-list {
            display: grid;
            gap: 6px;
        }
        .task-item {
            background: var(--surface-strong);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 6px 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .item-card.expanded .card-details + * span[style*="transition"] {
            transform: rotate(180deg);
        }
        .item-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(79, 110, 247, 0.1);
        }
        .task-header {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            position: relative;
            padding-right: 80px;
            margin-bottom: 8px;
        }
        .task-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-main);
        }
        .task-desc {
            font-size: 0.88rem;
            color: var(--text-muted);
            line-height: 1.5;
        }
        .task-type {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 3px 10px;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            color: #fff;
        }
        .task-type-simple {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a8a0 100%);
        }
        .task-type-hard {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        .task-type-extreme {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        .item-list {
            display: grid;
            gap: 8px;
        }
        .item-card {
            background: var(--surface-strong);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 8px 10px;
        }
        .empty-tip {
            color: #98a0c2;
            text-align: center;
            padding: 12px 10px;
            font-size: 0.9rem;
            background: var(--surface-strong);
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .error-tip {
            color: #b83232;
            background: #ffe9e9;
            border: 1px solid #ffc9c9;
            border-radius: 12px;
            padding: 12px 14px;
            line-height: 1.5;
        }
        @media (max-width: 640px) {
            body {
                padding: 10px;
            }
            .status-card {
                padding: 16px;
                border-radius: 18px;
            }
            .status-meta {
                grid-template-columns: repeat(3, 1fr);
                width: 100%;
            }
            .meta-label {
                font-size: 0.6rem;
            }
            .meta-value {
                font-size: 0.75rem;
                word-break: break-word;
                overflow-wrap: break-word;
            }
            .metric-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .metric-value {
                font-size: 1.15rem;
            }
            .task-header {
                padding-right: 70px;
            }
            .task-item {
                position: relative;
            }
            .task-item [style*="position: absolute"] {
                position: absolute !important;
                top: 8px !important;
                right: 8px !important;
                font-size: 0.7rem !important;
                padding: 3px 8px !important;
                white-space: nowrap;
            }
            .task-name {
                font-size: 0.85rem;
                flex: 1;
                min-width: 0;
                word-break: break-word;
            }
        }
    </style>
</head>
<body>
<div class="status-card" id="status-card">
    <header class="status-header">
        <div class="status-title">
            <h1>æ— é™ä¹‹æ—…</h1>
            <p class="status-subtitle">ç»´åº¦ç©¿æ¢­é€šç”¨æ§åˆ¶é¢æ¿</p>
        </div>
        <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </header>
    
    <div class="status-meta">
        <div class="meta-item">
            <span class="meta-label">ğŸŒ ä¸–ç•Œåç§°</span>
            <span class="meta-value" id="world-name-top">æœªé”šå®š</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">ğŸ“ å½“å‰ä½ç½®</span>
            <span class="meta-value" id="current-location-top">æœªè®°å½•ä½ç½®</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">ğŸ’° å½“åœ°èµ„é‡‘</span>
            <span class="meta-value" id="local-currency">-</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">ğŸ’ èƒ½é‡å‚¨å¤‡</span>
            <span class="meta-value" id="energy-value">1000 pts</span>
        </div>
    </div>

    <div class="panel-block" style="margin-top: 4px;">
        <h3 class="panel-title">å½“å‰æ—¥å¿—</h3>
        <div class="text-item">
            <p class="info-text" id="vina-thoughts">ç³»ç»Ÿå¾…æœºä¸­ï¼Œç­‰å¾…æŒ‡ä»¤...</p>
        </div>
    </div>

    <nav class="tab-strip" role="tablist">
        <div class="tab-item">
            <button type="button" class="tab-button" data-tab="captain" onclick="switchTab('captain', this)">ç©å®¶æ•°æ®</button>
            <section class="tab-panel" id="tab-content-captain">
                <div class="panel-block">
                    <h3 class="panel-title">æ ¸å¿ƒçŠ¶æ€</h3>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-label">ğŸ”´ ç”Ÿå‘½å€¼ (HP)</span>
                            <span class="metric-value">
                                <span id="hp-main">100</span>
                                <span class="metric-desc" id="hp-desc">/ 100</span>
                            </span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="hp-bar" class="progress-bar-value" style="width: 100%; background-color: #f44336;"></div>
                        </div>
                    </div>
                    <div class="metric-card" style="margin-top: 10px;">
                        <div class="metric-header">
                            <span class="metric-label">ğŸ”µ æ ¸å¿ƒè¿æ¥ (Link)</span>
                            <span class="metric-value">
                                <span id="link-main">0</span>
                                <span class="metric-desc" id="link-desc">/ 1000</span>
                            </span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="link-bar" class="progress-bar-value" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">ç©å®¶å±æ€§</h3>
                    <div class="info-grid">
                        <div class="info-card">
                            <span class="info-label">åŠ›é‡</span>
                            <span class="info-value" id="str-value">10 + 0</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">é˜²å¾¡</span>
                            <span class="info-value" id="def-value">10 + 0</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">æ•æ·</span>
                            <span class="info-value" id="agi-value">10 + 0</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">é­…åŠ›</span>
                            <span class="info-value" id="chr-value">10 + 0</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">å¹¸è¿</span>
                            <span class="info-value" id="luk-value">10 + 0</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">ğŸŒ å·²åˆ°è¾¾ä¸–ç•Œæ•°é‡</span>
                            <span class="info-value" id="worlds-visited">0</span>
                        </div>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">è£…å¤‡æ§½ä½</h3>
                    <div class="info-grid">
                        <div class="info-card">
                            <span class="info-label">âš”ï¸ æ­¦å™¨</span>
                            <span class="info-value" id="equip-weapon">ç©º</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">ğŸ›¡ï¸ é˜²å…·</span>
                            <span class="info-value" id="equip-armor">ç©º</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">ğŸ‘• æœè£…</span>
                            <span class="info-value" id="equip-clothes">ç©º</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">ğŸ’ é¥°å“</span>
                            <span class="info-value" id="equip-accessory">ç©º</span>
                        </div>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">å¤©èµ‹ä¸èƒ½åŠ›</h3>
                    <div class="text-group">
                        <div class="text-item">
                            <span class="info-label">å¤©èµ‹ (Passive)</span>
                            <p class="info-text" id="talents-list">ç»´åº¦æ—…è€…ï¼šå…ç–«æ—¶ç©ºç©¿æ¢­çš„çœ©æ™•æ„Ÿï¼Œèƒ½å¤Ÿå¬æ‡‚ä»»ä½•ä¸–ç•Œçš„è¯­è¨€ã€‚</p>
                        </div>
                        <div class="text-item">
                            <span class="info-label">èƒ½åŠ› (Active)</span>
                            <p class="info-text" id="abilities-list">åŸºç¡€æ¢æŸ¥æœ¯ [æ¶ˆè€—: 3 èƒ½é‡]ï¼šåˆ†æç›®æ ‡ç”Ÿç‰©æˆ–ç‰©å“çš„åŸºç¡€ä¿¡æ¯ã€‚</p>
                        </div>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">ç‰©èµ„ä»“åº“</h3>
                    <div id="inventory-list" class="item-list"></div>
                </div>
            </section>
        </div>
        <div class="tab-item">
            <button type="button" class="tab-button" data-tab="spatial" onclick="switchTab('spatial', this)">è½½å…·ç®¡ç†</button>
            <section class="tab-panel" id="tab-content-spatial">
                <div class="panel-block">
                    <h3 class="panel-title">è½½å…·æ ¸å¿ƒçŠ¶æ€</h3>
                    <div class="info-grid">
                        <div class="info-card">
                            <span class="info-label">è½½å…·ç±»å‹</span>
                            <span class="info-value" id="vehicle-type">æœªåˆå§‹åŒ–</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">æ ¸å¿ƒåç§°</span>
                            <span class="info-value" id="core-name">æœªå‘½å</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">çŠ¶æ€</span>
                            <span class="info-value" id="vina-status">å¾…æœº</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">åŒæ­¥ç‡é˜¶æ®µ</span>
                            <span class="info-value" id="vina-stage">0</span>
                        </div>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">è½½å…·ç©ºé—´ç»Ÿç­¹</h3>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-label">ğŸ—ï¸ ç‰©ç†ç©ºé—´</span>
                            <span class="metric-value">
                                <span id="space-used">150</span>
                                <span class="metric-desc" id="space-total">/ 1000</span>
                            </span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="space-bar" class="progress-bar-value" style="width: 15%;"></div>
                        </div>
                    </div>
                    <div class="metric-card" style="margin-top: 10px;">
                        <div class="metric-header">
                            <span class="metric-label">ğŸ‘¥ ç”Ÿå‘½æ‰¿è½½</span>
                            <span class="metric-value">
                                <span id="capacity-current">0</span>
                                <span class="metric-desc" id="capacity-max">/ 1</span>
                            </span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="capacity-bar" class="progress-bar-value" style="width: 0%; background-color: #009688;"></div>
                        </div>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">è½½å…·æˆå‘˜</h3>
                    <div id="members-list" class="item-list"></div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">å»ºç­‘å¸ƒå±€è¯¦æƒ…</h3>
                    <div id="buildings-list" style="display: grid; gap: 12px; margin-top: 8px;"></div>
                </div>
            </section>
        </div>
        <div class="tab-item">
            <button type="button" class="tab-button" data-tab="social" onclick="switchTab('social', this)">ä¸–ç•Œä¿¡æ¯</button>
            <section class="tab-panel" id="tab-content-social">
                <div class="panel-block">
                    <h3 class="panel-title">ä¸–ç•ŒåŸºæœ¬ä¿¡æ¯</h3>
                    <div class="info-grid">
                        <div class="info-card">
                            <span class="info-label">ğŸ›ï¸ æ–‡æ˜ç±»å‹</span>
                            <span class="info-value" id="civilization-type">-</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">ğŸ“ å‰§æƒ…èŠ‚ç‚¹</span>
                            <span class="info-value" id="plot-node">-</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">ğŸ­ ä¼ªè£…èº«ä»½</span>
                            <span class="info-value" id="disguise-identity">-</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">ğŸšª ç»´åº¦é—¨æ‹Ÿæ€</span>
                            <span class="info-value" id="door-morph">-</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">ğŸ“š ç»´åº¦æ˜ å°„</span>
                            <span class="info-value" id="dimension-mapping">-</span>
                        </div>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">ä¸–ç•ŒèƒŒæ™¯è®¾å®š</h3>
                    <div class="text-item">
                        <p class="info-text" id="world-background">æš‚æ— ä¸–ç•ŒèƒŒæ™¯ä¿¡æ¯</p>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">å½“å‰ä¸–ç•ŒåŠ›é‡å±‚çº§</h3>
                    <div class="text-item">
                        <p class="info-text" id="user-power-level">-</p>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">å½“å‰ä¸–ç•ŒåŠ›é‡ä½“ç³»</h3>
                    <div class="text-item">
                        <p class="info-text" id="world-power-system">æš‚æ— åŠ›é‡ä½“ç³»ä¿¡æ¯</p>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">å½“å‰ä¸–ç•Œè§„åˆ™</h3>
                    <div class="text-item">
                        <p class="info-text" id="world-rules">æš‚æ— è§„åˆ™ä¿¡æ¯</p>
                    </div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">NPC è®°å½•</h3>
                    <div id="local-npcs" style="display: grid; gap: 10px; margin-top: 8px;"></div>
                </div>
                <div class="panel-block">
                    <h3 class="panel-title">åŠ¿åŠ›æƒ…æŠ¥</h3>
                    <div id="world-factions" style="display: grid; gap: 10px; margin-top: 8px;"></div>
                </div>
            </section>
        </div>
        <div class="tab-item">
            <button type="button" class="tab-button" data-tab="missions" onclick="switchTab('missions', this)">å‘½è¿æ¸…å•</button>
            <section class="tab-panel" id="tab-content-missions">
                <div id="missions-list" class="task-list"></div>
            </section>
        </div>
    </nav>
</div>

<script>
    // --- è¾…åŠ©å‡½æ•°å®šä¹‰åŒºåŸŸ (ä» initDisplay ä¸­ç§»å‡ºä»¥é¿å…åµŒå¥—é”™è¯¯) ---

    function SafeGetValue(obj, path, defaultValue = "N/A") {
        if (!obj || typeof obj !== 'object') {
            return defaultValue;
        }
        let keys = Array.isArray(path) ? path : path.split('.');
        let current = obj;
        for (let i = 0; i < keys.length; i++) {
            if (current === undefined || current === null || typeof current !== 'object') {
                return defaultValue;
            }
            const key = keys[i];
            if (!current.hasOwnProperty(key)) {
                return defaultValue;
            }
            current = current[key];
            if (current === '$meta' || (typeof current === 'object' && current !== null && current.hasOwnProperty && current.hasOwnProperty('$meta'))) {
                return defaultValue;
            }
        }
        if (current === undefined || current === null) {
            return defaultValue;
        }
        if (current === '$__META_EXTENSIBLE__$' || current === '$meta') {
            return defaultValue;
        }
        if (Array.isArray(current)) {
            if (current.length > 0) {
                const actualValue = current[0];
                if (actualValue === '$__META_EXTENSIBLE__$' || actualValue === '$meta') {
                    return defaultValue;
                }
                if (typeof actualValue === 'boolean') {
                    return actualValue;
                }
                return String(actualValue);
            } else {
                return defaultValue;
            }
        }
        if (typeof current === 'boolean') {
            return current;
        }
        if (typeof current === 'number') {
            return current;
        }
        if (typeof current === 'string') {
            return current;
        }
        if (typeof current === 'object' && current !== null) {
            if (current.hasOwnProperty('$meta')) {
                return defaultValue;
            }
            return JSON.stringify(current);
        }
        return JSON.stringify(current);
    }

    function SafeGetValueWithFallback(obj, pathArray, defaultValue = "N/A") {
        for (let i = 0; i < pathArray.length; i++) {
            const result = SafeGetValue(obj, pathArray[i], null);
            if (result !== null && result !== 'N/A' && result !== '' && result !== undefined) {
                return result;
            }
        }
        return defaultValue;
    }

    function updateProgressBar(barId, valueMainId, valueDescId, rawValue, min = 0, max = 100, color) {
        const progressBar = document.getElementById(barId);
        const valueMainDisplay = document.getElementById(valueMainId);
        const valueDescDisplay = document.getElementById(valueDescId);
        if (!progressBar || !valueMainDisplay) {
            return;
        }
        let numericValue = parseFloat(rawValue);
        if (isNaN(numericValue)) {
            numericValue = parseFloat(String(rawValue).replace(/[^0-9.-]/g, ''));
        }
        if (!isNaN(numericValue)) {
            valueMainDisplay.innerText = numericValue;
        } else {
            valueMainDisplay.innerText = rawValue;
        }
        if (valueDescDisplay) {
            valueDescDisplay.innerText = '';
        }
        if (!isNaN(numericValue)) {
            numericValue = Math.max(min, Math.min(max, numericValue));
            const range = max - min;
            const percentage = range === 0 ? (numericValue >= max ? 100 : 0) : ((numericValue - min) / range) * 100;
            progressBar.style.width = `${Math.max(0, Math.min(100, percentage))}%`;
            progressBar.style.backgroundColor = color ? color : '#667eea';
        }
    }

    function formatEquipmentSimple(equip) {
        if (!equip || equip === null || equip === 'null' || equip === 'N/A' || equip === '') {
            return 'ç©º';
        }
        if (Array.isArray(equip)) {
            if (equip.length === 0) {
                return 'ç©º';
            }
            equip = equip[0];
        }
        if (typeof equip === 'string') {
            return equip;
        }
        if (typeof equip === 'object' && equip !== null) {
            const name = equip['åç§°'] || equip['name'] || '';
            return name || 'ç©º';
        }
        return 'ç©º';
    }

    function formatBackpackItemSimple(item) {
        if (typeof item === 'object' && item['åç§°']) {
            return item['åç§°'];
        }
        return String(item);
    }

    function formatEquipment(equip) {
        if (!equip || equip === null || equip === 'null' || equip === 'N/A' || equip === '') {
            return 'ç©º';
        }
        if (Array.isArray(equip)) {
            if (equip.length === 0) {
                return 'ç©º';
            }
            equip = equip[0];
        }
        if (typeof equip === 'string') {
            return equip;
        }
        if (typeof equip === 'object' && equip !== null) {
            const name = equip['åç§°'] || equip['name'] || '';
            if (!name) {
                return 'ç©º';
            }
            const effects = equip['æ•ˆæœ'] || equip['effects'] || equip['å±æ€§å¢å¹…'] || '';
            let effectStr = '';
            if (effects) {
                if (typeof effects === 'string') {
                    effectStr = ' (' + effects + ')';
                } else if (typeof effects === 'object') {
                    const effectParts = [];
                    if (effects['åŠ›é‡']) effectParts.push('åŠ›é‡+' + effects['åŠ›é‡']);
                    if (effects['é˜²å¾¡']) effectParts.push('é˜²å¾¡+' + effects['é˜²å¾¡']);
                    if (effects['æ•æ·']) effectParts.push('æ•æ·+' + effects['æ•æ·']);
                    if (effects['é­…åŠ›']) effectParts.push('é­…åŠ›+' + effects['é­…åŠ›']);
                    if (effects['å¹¸è¿']) effectParts.push('å¹¸è¿+' + effects['å¹¸è¿']);
                    if (effectParts.length > 0) {
                        effectStr = ' (' + effectParts.join(', ') + ')';
                    } else {
                        effectStr = ' (' + JSON.stringify(effects) + ')';
                    }
                }
            }
            return name + effectStr;
        }
        return 'ç©º';
    }

    function cleanLogText(text) {
        if (!text) return '';
        return text.trim()
            .replace(/\\n/g, ' ')
            .replace(/\n/g, ' ')
            .replace(/\s+/g, ' ')
            .replace(/ã€‚+/g, 'ã€‚')
            .replace(/'\s*\+\s*'/g, '')
            .replace(/"\s*\+\s*"/g, '')
            .replace(/\+\s*'/g, '')
            .replace(/'\s*\+/g, '')
            .replace(/\+\s*"/g, '')
            .replace(/"\s*\+/g, '');
    }

    // --- ä¸»é€»è¾‘å‡½æ•° ---

    async function initDisplay() {
        try {
            const messages = await getChatMessages(getCurrentMessageId());
            if (!messages || messages.length === 0 || !messages[0].data) {
                document.getElementById('status-card').innerHTML = "<div class='error-tip'>æ— æ³•åŠ è½½çŠ¶æ€æ•°æ® (messages empty)</div>";
                return;
            }
            const gameData = messages[0].data;
            const characterData = gameData.stat_data;
            if (!characterData) {
                document.getElementById('status-card').innerHTML = "<div class='error-tip'>æ— æ³•åŠ è½½çŠ¶æ€æ•°æ® (characterData missing)</div>";
                return;
            }

            const energyValue = SafeGetValue(characterData, 'æœ¬æºèƒ½é‡', 1000);
            const energyElem = document.getElementById('energy-value');
            if (energyElem) {
                energyElem.innerText = energyValue + ' pts';
                if (parseFloat(energyValue) <= 500) {
                    energyElem.classList.add('danger');
                } else {
                    energyElem.classList.remove('danger');
                }
            }

            const worldName = SafeGetValue(characterData, 'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•Œåç§°', 'æœªé”šå®š');
            const worldNameTopElem = document.getElementById('world-name-top');
            if (worldNameTopElem) worldNameTopElem.innerText = worldName;

            const currentLocation = SafeGetValue(characterData, 'å½“å‰ä½ç½®', 'æœªè®°å½•ä½ç½®');
            const locationElem = document.getElementById('current-location-top');
            if (locationElem) {
                locationElem.innerText = currentLocation;
                locationElem.setAttribute('title', currentLocation);
            }

            const civilizationType = SafeGetValueWithFallback(characterData, [
                'å½“å‰ä¸–ç•Œä¿¡æ¯.æ–‡æ˜ç±»å‹',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•Œæ–‡æ˜ç±»å‹'
            ], '-');
            const civTypeElem = document.getElementById('civilization-type');
            if (civTypeElem) civTypeElem.innerText = civilizationType !== 'N/A' ? civilizationType : '-';

            const disguiseIdentity = SafeGetValueWithFallback(characterData, [
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¼ªè£…èº«ä»½',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.èº«ä»½ä¼ªè£…'
            ], '-');
            const disguiseElem = document.getElementById('disguise-identity');
            if (disguiseElem) disguiseElem.innerText = disguiseIdentity !== 'N/A' ? disguiseIdentity : '-';

            const doorMorph = SafeGetValueWithFallback(characterData, [
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ç»´åº¦é—¨æ‹Ÿæ€',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.é—¨æ‹Ÿæ€'
            ], '-');
            const doorElem = document.getElementById('door-morph');
            if (doorElem) doorElem.innerText = doorMorph;

            const dimensionMapping = SafeGetValueWithFallback(characterData, [
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ç»´åº¦æ˜ å°„',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•Œç»´åº¦æ˜ å°„'
            ], '-');
            const dimensionMappingElem = document.getElementById('dimension-mapping');
            if (dimensionMappingElem) {
                dimensionMappingElem.innerText = dimensionMapping !== 'N/A' ? dimensionMapping : '-';
            }

            const plotNode = SafeGetValueWithFallback(characterData, [
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•Œå‰§æƒ…èŠ‚ç‚¹',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.å‰§æƒ…èŠ‚ç‚¹',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•Œå‰§æœ¬èŠ‚ç‚¹'
            ], '');
            const plotNodeElem = document.getElementById('plot-node');
            if (plotNodeElem) plotNodeElem.innerText = plotNode && plotNode !== 'N/A' && plotNode !== '' ? plotNode : '-';

            const localCurrencyData = characterData['ä¸–ç•Œè´§å¸'] || {};
            const localCurrencyElem = document.getElementById('local-currency');
            if (localCurrencyElem) {
                const currencyEntries = Object.entries(localCurrencyData).filter(([key, value]) => 
                    key !== '$meta' && value !== '$__META_EXTENSIBLE__$'
                );
                
                if (currencyEntries.length > 0) {
                    const currencyDisplay = currencyEntries.map(([name, amount]) => 
                        `${amount} ${name}`
                    ).join(' | ');
                    localCurrencyElem.innerText = currencyDisplay;
                } else {
                    localCurrencyElem.innerText = '-';
                }
            }

            const vehicleType = SafeGetValueWithFallback(characterData, [
                'è½½å…·æ ¸å¿ƒ.ç±»å‹',
                'è½½å…·æ ¸å¿ƒ.è½½å…·ç±»å‹'
            ], 'æœªåˆå§‹åŒ–');
            const vehicleTypeElem = document.getElementById('vehicle-type');
            if (vehicleTypeElem) vehicleTypeElem.innerText = vehicleType !== 'N/A' ? vehicleType : 'æœªåˆå§‹åŒ–';

            const coreName = SafeGetValueWithFallback(characterData, [
                'è½½å…·æ ¸å¿ƒ.åç§°',
                'è½½å…·æ ¸å¿ƒ.æ ¸å¿ƒåç§°'
            ], 'æœªå‘½å');
            const coreNameElem = document.getElementById('core-name');
            if (coreNameElem) coreNameElem.innerText = coreName !== 'N/A' ? coreName : 'æœªå‘½å';

            const vinaStatus = SafeGetValueWithFallback(characterData, [
                'è½½å…·æ ¸å¿ƒ.å½“å‰çŠ¶æ€',
                'è½½å…·æ ¸å¿ƒ.çŠ¶æ€'
            ], 'å¾…æœº');
            const vinaStatusElem = document.getElementById('vina-status');
            if (vinaStatusElem) vinaStatusElem.innerText = vinaStatus && vinaStatus !== 'N/A' ? vinaStatus : 'å¾…æœº';

            const vinaStage = SafeGetValueWithFallback(characterData, [
                'è½½å…·æ ¸å¿ƒ.åŒæ­¥ç‡é˜¶æ®µ',
                'è½½å…·æ ¸å¿ƒ.é˜¶æ®µ'
            ], 0);
            const vinaStageElem = document.getElementById('vina-stage');
            if (vinaStageElem) vinaStageElem.innerText = String(vinaStage && vinaStage !== 'N/A' ? vinaStage : 0);

            const stayTime = SafeGetValueWithFallback(characterData, [
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•Œæ»ç•™æ—¶é—´',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.æ»ç•™æ—¶é—´'
            ], '');
            const currentTime = SafeGetValueWithFallback(characterData, [
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•Œå½“å‰æ—¶é—´',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.å½“å‰æ—¶é—´'
            ], '');
            
            const vinaThoughts = SafeGetValueWithFallback(characterData, [
                'è½½å…·æ ¸å¿ƒ.å½“å‰æ—¥å¿—',
                'è½½å…·æ ¸å¿ƒ.æ—¥å¿—',
                'è½½å…·æ ¸å¿ƒ.æƒ³æ³•'
            ], 'ç³»ç»Ÿå¾…æœºä¸­ï¼Œç­‰å¾…æŒ‡ä»¤...');
            const vinaThoughtsElem = document.getElementById('vina-thoughts');
            if (vinaThoughtsElem) {
                if (vinaThoughts && vinaThoughts !== 'N/A' && vinaThoughts !== 'ç³»ç»Ÿå¾…æœºä¸­ï¼Œç­‰å¾…æŒ‡ä»¤...') {
                    const thoughtsStr = String(vinaThoughts);
                    
                    let parsedStayTime = '';
                    let parsedCurrentTime = '';
                    let timeReasoning = '';
                    let summary = '';
                    let evaluation = '';
                    let suggestion = '';
                    
                    const stayMatch1 = thoughtsStr.match(/ã€ä¸–ç•Œæ»ç•™æ—¶é—´[ï¼š:]([^ã€‘]+)ã€‘/);
                    const stayMatch2 = thoughtsStr.match(/ä¸–ç•Œæ»ç•™æ—¶é—´[ï¼š:]([^ã€‚\nã€]+)/);
                    parsedStayTime = stayMatch1 ? stayMatch1[1] : (stayMatch2 ? stayMatch2[1] : '');
                    
                    const timeMatch1 = thoughtsStr.match(/ã€ä¸–ç•Œå½“å‰æ—¶é—´[ï¼š:]([^ã€‘]+)ã€‘/);
                    const timeMatch2 = thoughtsStr.match(/ä¸–ç•Œå½“å‰æ—¶é—´[ï¼š:]([^ã€‚\nã€]+)/);
                    parsedCurrentTime = timeMatch1 ? timeMatch1[1] : (timeMatch2 ? timeMatch2[1] : '');
                    
                    const reasonMatch1 = thoughtsStr.match(/ã€æ—¶é—´æ¨ç†[ï¼š:]([^ã€‘]+)ã€‘/);
                    const reasonMatch2 = thoughtsStr.match(/æ—¶é—´æ¨ç†[ï¼š:]([\s\S]+?)(?=\n\s*æœ¬å›åˆæ€»ç»“|\n\s*ç®€è¦æ€»ç»“|\n\s*è¯„ä»·[ï¼š:]|\n\s*å»ºè®®[ï¼š:]|$)/);
                    timeReasoning = reasonMatch1 ? reasonMatch1[1].trim() : (reasonMatch2 ? reasonMatch2[1].trim() : '');
                    
                    const summaryMatch1 = thoughtsStr.match(/æœ¬å›åˆæ€»ç»“[ï¼š:]([\s\S]*?)(?=\n\s*(è¯„ä»·|å»ºè®®)[ï¼š:]|$)/m);
                    const summaryMatch2 = thoughtsStr.match(/ç®€è¦æ€»ç»“[ï¼š:]([\s\S]*?)(?=\n\s*(è¯„ä»·|å»ºè®®)[ï¼š:]|$)/m);
                    summary = summaryMatch1 ? summaryMatch1[1].trim() : (summaryMatch2 ? summaryMatch2[1].trim() : '');
                    if (summary) {
                        const lines = summary.split('\n');
                        let cleanSummary = [];
                        for (let i = 0; i < lines.length; i++) {
                            const trimmed = lines[i].trim();
                            if (trimmed.match(/^(è¯„ä»·|å»ºè®®)[ï¼š:]/)) {
                                break;
                            }
                            cleanSummary.push(lines[i]);
                        }
                        summary = cleanSummary.join('\n').trim();
                        summary = summary.replace(/è¯„ä»·[ï¼š:][\s\S]*$/m, '').trim();
                        summary = summary.replace(/å»ºè®®[ï¼š:][\s\S]*$/m, '').trim();
                    }
                    
                    const evalMatch = thoughtsStr.match(/è¯„ä»·[ï¼š:]([\s\S]+?)(?=\n\s*å»ºè®®[ï¼š:]|$)/m);
                    evaluation = evalMatch ? evalMatch[1].trim() : '';
                    
                    const suggMatch = thoughtsStr.match(/å»ºè®®[ï¼š:]([\s\S]+?)$/m);
                    suggestion = suggMatch ? suggMatch[1].trim() : '';
                    
                    let html = '<div style="line-height: 1.6; font-size: 0.9rem;">';
                    
                    const displayStayTime = stayTime && stayTime !== 'N/A' && stayTime !== '' ? stayTime : parsedStayTime;
                    const displayCurrentTime = currentTime && currentTime !== 'N/A' && currentTime !== '' ? currentTime : parsedCurrentTime;
                    
                    if (displayStayTime || displayCurrentTime) {
                        html += '<div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.1);">';
                        if (displayStayTime) {
                            html += '<div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 4px;"><strong>â³ ä¸–ç•Œæ»ç•™æ—¶é—´ï¼š</strong><span style="color: var(--text-main);">' + cleanLogText(displayStayTime) + '</span></div>';
                        }
                        if (displayCurrentTime) {
                            html += '<div style="color: var(--text-muted); font-size: 0.85rem;"><strong>ğŸ“… ä¸–ç•Œå½“å‰æ—¶é—´ï¼š</strong><span style="color: var(--text-main);">' + cleanLogText(displayCurrentTime) + '</span></div>';
                        }
                        html += '</div>';
                    }
                    
                    if (timeReasoning || summary || evaluation || suggestion) {
                        html += '<div style="padding: 8px 10px; background: var(--surface); border-left: 2px solid var(--border); border-radius: 4px;">';
                        
                        if (timeReasoning) {
                            html += '<div style="margin-bottom: 8px;"><div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px; font-weight: 600;">ğŸ• æ—¶é—´æ¨ç†</div><div style="color: var(--text-main); line-height: 1.4; font-size: 0.85rem;">' + cleanLogText(timeReasoning) + '</div></div>';
                        }
                        
                        if (summary) {
                            html += '<div style="margin-bottom: 8px;"><div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px; font-weight: 600;">ğŸ“ æœ¬å›åˆæ€»ç»“</div><div style="color: var(--text-main); line-height: 1.4; font-size: 0.85rem;">' + cleanLogText(summary) + '</div></div>';
                        }
                        
                        if (evaluation) {
                            html += '<div style="margin-bottom: 8px;"><div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px; font-weight: 600;">ğŸ’­ è¯„ä»·</div><div style="color: var(--text-main); line-height: 1.4; font-size: 0.85rem;">' + cleanLogText(evaluation) + '</div></div>';
                        }
                        
                        if (suggestion) {
                            html += '<div><div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px; font-weight: 600;">ğŸ’¡ å»ºè®®</div><div style="color: var(--text-main); line-height: 1.4; font-size: 0.85rem;">' + cleanLogText(suggestion) + '</div></div>';
                        }
                        
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    
                    if (!displayStayTime && !displayCurrentTime && !timeReasoning && !summary && !evaluation && !suggestion) {
                        html = '<div style="line-height: 1.6; font-size: 0.9rem; color: var(--text-main); white-space: pre-wrap;">' + cleanLogText(thoughtsStr) + '</div>';
                    }
                    
                    vinaThoughtsElem.innerHTML = html;
                } else {
                    vinaThoughtsElem.innerText = 'ç³»ç»Ÿå¾…æœºä¸­ï¼Œç­‰å¾…æŒ‡ä»¤...';
                }
            }

            const syncRate = SafeGetValue(characterData, 'è½½å…·åŒæ­¥ç‡', 0);
            const syncColor = parseFloat(syncRate) < 100 ? '#03A9F4' : parseFloat(syncRate) < 450 ? '#4CAF50' : parseFloat(syncRate) < 850 ? '#FFC107' : '#FF9800';
            updateProgressBar('link-bar', 'link-main', 'link-desc', syncRate, 0, 1000, syncColor);
            const linkDescElem = document.getElementById('link-desc');
            if (linkDescElem) linkDescElem.innerText = ' / 1000';

            const hpCurrent = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.ç”Ÿå‘½å€¼.å½“å‰å€¼', 100);
            const hpMax = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.ç”Ÿå‘½å€¼.æœ€å¤§å€¼', 100);
            updateProgressBar('hp-bar', 'hp-main', 'hp-desc', hpCurrent, 0, parseFloat(hpMax), '#f44336');
            const hpDescElem = document.getElementById('hp-desc');
            if (hpDescElem) hpDescElem.innerText = ' / ' + hpMax;


            const strBase = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.åŠ›é‡.åŸºç¡€å€¼', 10);
            const strBuff = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.åŠ›é‡.åŠ æˆå€¼', 0);
            const strElem = document.getElementById('str-value');
            if (strElem) strElem.innerText = strBase + ' + ' + strBuff;

            const defBase = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.é˜²å¾¡.åŸºç¡€å€¼', 10);
            const defBuff = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.é˜²å¾¡.åŠ æˆå€¼', 0);
            const defElem = document.getElementById('def-value');
            if (defElem) defElem.innerText = defBase + ' + ' + defBuff;

            const agiBase = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.æ•æ·.åŸºç¡€å€¼', 10);
            const agiBuff = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.æ•æ·.åŠ æˆå€¼', 0);
            const agiElem = document.getElementById('agi-value');
            if (agiElem) agiElem.innerText = agiBase + ' + ' + agiBuff;

            const chrBase = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.é­…åŠ›.åŸºç¡€å€¼', 10);
            const chrBuff = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.é­…åŠ›.åŠ æˆå€¼', 0);
            const chrElem = document.getElementById('chr-value');
            if (chrElem) chrElem.innerText = chrBase + ' + ' + chrBuff;

            const lukBase = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.å¹¸è¿.åŸºç¡€å€¼', 10);
            const lukBuff = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.å¹¸è¿.åŠ æˆå€¼', 0);
            const lukElem = document.getElementById('luk-value');
            if (lukElem) lukElem.innerText = lukBase + ' + ' + lukBuff;

            const worldsVisited = SafeGetValue(characterData, 'ä¸»è§’å±æ€§.å·²åˆ°è¾¾ä¸–ç•Œæ•°é‡', 0);
            const worldsVisitedElem = document.getElementById('worlds-visited');
            if (worldsVisitedElem) worldsVisitedElem.innerText = String(worldsVisited);

            const weaponRaw = characterData && characterData['ä¸»è§’è£…å¤‡æ '] && characterData['ä¸»è§’è£…å¤‡æ ']['æ­¦å™¨'] ? characterData['ä¸»è§’è£…å¤‡æ ']['æ­¦å™¨'] : null;
            const weaponElem = document.getElementById('equip-weapon');
            if (weaponElem) weaponElem.innerText = formatEquipment(weaponRaw);

            const armorRaw = characterData && characterData['ä¸»è§’è£…å¤‡æ '] && characterData['ä¸»è§’è£…å¤‡æ ']['é˜²å…·'] ? characterData['ä¸»è§’è£…å¤‡æ ']['é˜²å…·'] : null;
            const armorElem = document.getElementById('equip-armor');
            if (armorElem) armorElem.innerText = formatEquipment(armorRaw);

            const clothesRaw = characterData && characterData['ä¸»è§’è£…å¤‡æ '] && characterData['ä¸»è§’è£…å¤‡æ ']['æœè£…'] ? characterData['ä¸»è§’è£…å¤‡æ ']['æœè£…'] : null;
            const clothesElem = document.getElementById('equip-clothes');
            if (clothesElem) clothesElem.innerText = formatEquipment(clothesRaw);

            const accessoryRaw = characterData && characterData['ä¸»è§’è£…å¤‡æ '] && characterData['ä¸»è§’è£…å¤‡æ ']['é¥°å“'] ? characterData['ä¸»è§’è£…å¤‡æ ']['é¥°å“'] : null;
            const accessoryElem = document.getElementById('equip-accessory');
            if (accessoryElem) accessoryElem.innerText = formatEquipment(accessoryRaw);

            const talentsRaw = characterData['å¤©èµ‹æ '];
            const talentsElem = document.getElementById('talents-list');
            if (talentsElem) {
                if (Array.isArray(talentsRaw) && talentsRaw.length > 0) {
                    talentsElem.innerHTML = talentsRaw.map(t => {
                        if (typeof t === 'object' && t !== null) {
                            const name = t['åç§°'] || t['name'] || 'æœªçŸ¥å¤©èµ‹';
                            const effect = t['æ•ˆæœ'] || t['effect'] || '';
                            return '<div style="background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 4px 6px; margin-bottom: 4px;"><div style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 2px;">' + name + '</div><div style="font-size: 0.78rem; color: var(--text-main); line-height: 1.4;">' + effect + '</div></div>';
                        }
                        return '<div style="background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 4px 6px; margin-bottom: 4px; font-size: 0.8rem;">' + String(t) + '</div>';
                    }).join('');
                } else if (talentsRaw && !Array.isArray(talentsRaw)) {
                    const name = talentsRaw['åç§°'] || talentsRaw['name'] || 'æœªçŸ¥å¤©èµ‹';
                    const effect = talentsRaw['æ•ˆæœ'] || talentsRaw['effect'] || '';
                    talentsElem.innerHTML = '<div style="background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 4px 6px;"><div style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 2px;">' + name + '</div><div style="font-size: 0.78rem; color: var(--text-main); line-height: 1.4;">' + effect + '</div></div>';
                } else {
                    talentsElem.innerHTML = '<div style="background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 4px 6px;"><div style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 2px;">ç»´åº¦æ—…è€…</div><div style="font-size: 0.78rem; color: var(--text-main); line-height: 1.4;">å…ç–«æ—¶ç©ºç©¿æ¢­çš„çœ©æ™•æ„Ÿï¼Œèƒ½å¤Ÿå¬æ‡‚ä»»ä½•ä¸–ç•Œçš„è¯­è¨€ã€‚</div></div>';
                }
            }

            const abilitiesRaw = characterData['èƒ½åŠ›æ '];
            const abilitiesElem = document.getElementById('abilities-list');
            if (abilitiesElem) {
                if (Array.isArray(abilitiesRaw) && abilitiesRaw.length > 0) {
                    abilitiesElem.innerHTML = abilitiesRaw.map(a => {
                        if (typeof a === 'object' && a !== null) {
                            const name = a['åç§°'] || a['name'] || 'æœªçŸ¥èƒ½åŠ›';
                            const cost = a['æ¶ˆè€—'] || a['cost'] || 0;
                            const power = a['å¨åŠ›'] || a['power'] || 0;
                            const effect = a['æ•ˆæœ'] || a['effect'] || '';
                            return '<div style="background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 4px 6px; margin-bottom: 4px;"><div style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 2px;">' + name + ' <span style="font-size: 0.75rem; color: var(--text-muted);">[æ¶ˆè€—: ' + cost + ' èƒ½é‡' + (power > 0 ? ', å¨åŠ›: ' + power : '') + ']</span></div><div style="font-size: 0.78rem; color: var(--text-main); line-height: 1.4;">' + effect + '</div></div>';
                        }
                        return '<div style="background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 4px 6px; margin-bottom: 4px; font-size: 0.8rem;">' + String(a) + '</div>';
                    }).join('');
                } else if (abilitiesRaw && !Array.isArray(abilitiesRaw)) {
                    const name = abilitiesRaw['åç§°'] || abilitiesRaw['name'] || 'æœªçŸ¥èƒ½åŠ›';
                    const cost = abilitiesRaw['æ¶ˆè€—'] || abilitiesRaw['cost'] || 0;
                    const power = abilitiesRaw['å¨åŠ›'] || abilitiesRaw['power'] || 0;
                    const effect = abilitiesRaw['æ•ˆæœ'] || abilitiesRaw['effect'] || '';
                    abilitiesElem.innerHTML = '<div style="background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 4px 6px;"><div style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 2px;">' + name + ' <span style="font-size: 0.75rem; color: var(--text-muted);">[æ¶ˆè€—: ' + cost + ' èƒ½é‡' + (power > 0 ? ', å¨åŠ›: ' + power : '') + ']</span></div><div style="font-size: 0.78rem; color: var(--text-main); line-height: 1.4;">' + effect + '</div></div>';
                } else {
                    abilitiesElem.innerHTML = '<div style="background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 4px 6px;"><div style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 2px;">åŸºç¡€æ¢æŸ¥æœ¯ <span style="font-size: 0.75rem; color: var(--text-muted);">[æ¶ˆè€—: 3 èƒ½é‡]</span></div><div style="font-size: 0.78rem; color: var(--text-main); line-height: 1.4;">åˆ†æç›®æ ‡ç”Ÿç‰©æˆ–ç‰©å“çš„åŸºç¡€ä¿¡æ¯ï¼ˆåç§°ã€ç­‰çº§ã€æ•ˆç‡ï¼‰ã€‚</div></div>';
                }
            }

            const spaceUsed = SafeGetValue(characterData, 'è½½å…·ç©ºé—´ç»Ÿç­¹.å·²å ç”¨ç©ºé—´', 250);
            const spaceTotal = SafeGetValue(characterData, 'è½½å…·ç©ºé—´ç»Ÿç­¹.æ€»ç©ºé—´', 1000);
            updateProgressBar('space-bar', 'space-used', 'space-total', spaceUsed, 0, parseFloat(spaceTotal), '#3F51B5');
            const spaceTotalElem = document.getElementById('space-total');
            if (spaceTotalElem) spaceTotalElem.innerText = ' / ' + spaceTotal + ' SU';

            const vinaStatusForBuildings = SafeGetValueWithFallback(characterData, [
                'è½½å…·æ ¸å¿ƒ.å½“å‰çŠ¶æ€',
                'è½½å…·æ ¸å¿ƒ.çŠ¶æ€'
            ], 'æœªåˆå§‹åŒ–');
            const isVehicleInitialized = vinaStatusForBuildings !== 'æœªåˆå§‹åŒ–';

            const membersRaw = characterData['æˆå‘˜ç®¡ç†'] || [];
            const filteredMembers = Array.isArray(membersRaw) ? membersRaw : [];

            const buildingsRaw = characterData['å»ºç­‘å¸ƒå±€ä¸å†…è£…'] || [];
            const buildings = Array.isArray(buildingsRaw) ? buildingsRaw : [];
            
            const buildingsElem = document.getElementById('buildings-list');
            if (buildingsElem) {
                if (buildings.length > 0) {
                    buildingsElem.innerHTML = buildings.map(b => {
                        if (typeof b === 'object' && b !== null) {
                            const roomName = b['name'] || b['æˆ¿é—´åç§°'] || b['åç§°'] || 'æœªçŸ¥æˆ¿é—´';
                            const roomType = b['type'] || b['ç±»å‹'] || 'æœªçŸ¥';
                            const roomSpace = b['space'] || b['è½½å…·å ç”¨ç©ºé—´'] || 0;
                            
                            const capacityData = b['capacity'] || b['å±…ä½å®¹é‡'];
                            // const currentResidents = capacityData && typeof capacityData === 'object' ? (capacityData['current'] || capacityData['å½“å‰äººæ•°'] || 0) : 0;
                            const maxResidents = capacityData && typeof capacityData === 'object' ? (capacityData['max'] || capacityData['æœ€å¤§äººæ•°'] || 0) : 0;
                            
                            let furnitureList = [];
                            let facilitiesList = [];
                            let decorationList = [];
                            
                            if (b['items'] && Array.isArray(b['items'])) {
                                b['items'].forEach(item => {
                                    if (item && typeof item === 'object') {
                                        const name = item['name'] || item['åç§°'] || 'æœªçŸ¥';
                                        const type = item['type'] || item['ç±»å‹'] || '';
                                        const space = item['space'] || item['å ç”¨é¢ç§¯'] || item['å ç”¨'] || 0;
                                        const desc = item['desc'] || item['æè¿°'] || '';
                                        const lc = item['LC'];
                                        
                                        let displayText = name;
                                        if (space > 0) displayText += ' (' + space + ' SU)';
                                        if (lc !== undefined && lc !== null && lc > 0) {
                                            displayText += ' [LC:' + lc + ']';
                                        }
                                        if (desc) displayText += ' - ' + desc;
                                        
                                        if (type === 'å®¶å…·') {
                                            furnitureList.push(displayText);
                                        } else if (type === 'åŠŸèƒ½è®¾æ–½') {
                                            facilitiesList.push(displayText);
                                        } else if (type === 'è£…é¥°') {
                                            decorationList.push(displayText);
                                        } else {
                                            furnitureList.push(displayText);
                                        }
                                    } else if (typeof item === 'string') {
                                        furnitureList.push(item);
                                    }
                                });
                            }
                            
                            let residentsList = [];
                            let residentsNames = [];
                            if (maxResidents > 0) {
                                if (capacityData && capacityData['residents'] && Array.isArray(capacityData['residents'])) {
                                    residentsNames = capacityData['residents'];
                                }
                                
                                if (residentsNames.length > 0) {
                                    residentsList.push(`å½“å‰: ${residentsNames.length}/${maxResidents} äºº (${residentsNames.join('ã€')})`);
                                } else {
                                    residentsList.push(`å½“å‰: 0/${maxResidents} äºº (ç©ºç½®)`);
                                }
                            }
                            
                            let html = '<div class="item-card" style="padding: 6px 8px; cursor: pointer; position: relative;" onclick="toggleCardDetails(event, this)">';
                            html += '<div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; color: var(--primary); padding-right: 20px;">' + roomName + ' <span style="position: absolute; right: 8px; top: 6px; font-size: 0.7rem; color: var(--text-muted); transition: transform 0.2s;">â–¼</span></div>';
                            
                            html += '<div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">';
                            html += '<span style="margin-right: 10px;">ç±»å‹: <span style="font-weight: 600; color: var(--text-main);">' + roomType + '</span></span>';
                            html += '<span style="margin-right: 10px;">å ç”¨: <span style="font-weight: 600; color: var(--text-main);">' + roomSpace + ' SU</span></span>';
                            if (residentsList.length > 0) {
                                html += '<span>å®¹é‡: <span style="font-weight: 600; color: var(--text-main);">' + residentsList[0] + '</span></span>';
                            }
                            html += '</div>';
                            
                            if (furnitureList.length > 0 || facilitiesList.length > 0 || decorationList.length > 0) {
                                html += '<div class="card-details" style="display: none; margin-top: 4px; padding-top: 4px; border-top: 1px solid #e3e6f5;">';
                                
                                if (furnitureList.length > 0) {
                                    html += '<div style="margin-bottom: 4px;">';
                                    html += '<div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600; margin-bottom: 2px;">ğŸª‘ å®¶å…·:</div>';
                                    html += '<div style="font-size: 0.78rem; line-height: 1.4; padding-left: 12px;">';
                                    furnitureList.forEach(item => {
                                        html += 'â€¢ ' + item + '<br>';
                                    });
                                    html += '</div>';
                                    html += '</div>';
                                }
                                if (facilitiesList.length > 0) {
                                    html += '<div style="margin-bottom: 4px;">';
                                    html += '<div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600; margin-bottom: 2px;">âš™ï¸ åŠŸèƒ½è®¾æ–½:</div>';
                                    html += '<div style="font-size: 0.78rem; line-height: 1.4; padding-left: 12px;">';
                                    facilitiesList.forEach(item => {
                                        html += 'â€¢ ' + item + '<br>';
                                    });
                                    html += '</div>';
                                    html += '</div>';
                                }
                                if (decorationList.length > 0) {
                                    html += '<div style="margin-bottom: 4px;">';
                                    html += '<div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600; margin-bottom: 2px;">ğŸ¨ è£…é¥°:</div>';
                                    html += '<div style="font-size: 0.78rem; line-height: 1.4; padding-left: 12px;">';
                                    decorationList.forEach(item => {
                                        html += 'â€¢ ' + item + '<br>';
                                    });
                                    html += '</div>';
                                    html += '</div>';
                                }
                                
                                html += '</div>'; // å…³é—­ card-details
                            }
                            
                            html += '</div>'; // å…³é—­ item-card
                            return html;
                        }
                        return '';
                    }).join('');
                    
                    if (buildingsElem.innerHTML.trim() === '') {
                        buildingsElem.innerHTML = '<div class="empty-tip">æš‚æ— å»ºç­‘æ•°æ®</div>';
                    }
                } else {
                    if (isVehicleInitialized) {
                        buildingsElem.innerHTML = '<div class="empty-tip">æš‚æ— å»ºç­‘</div>';
                    } else {
                        buildingsElem.innerHTML = '<div class="empty-tip">â³ è½½å…·åˆå§‹åŒ–ä¸­ï¼Œå»ºç­‘æ•°æ®åŠ è½½ä¸­...</div>';
                    }
                }
            }

            let memberCount = filteredMembers.length;
            let bedCount = 0;
            
            if (buildings.length > 0) {
                bedCount = buildings.reduce((sum, b) => {
                    if (typeof b === 'object' && b !== null) {
                        if (b['items'] && Array.isArray(b['items'])) {
                            const roomLC = b['items'].reduce((lcSum, item) => {
                                if (item && typeof item === 'object' && item['LC']) {
                                    return lcSum + (parseFloat(item['LC']) || 0);
                                }
                                return lcSum;
                            }, 0);
                            return sum + roomLC;
                        }
                    }
                    return sum;
                }, 0);
            }
            if (bedCount === 0) bedCount = 1;
            
            updateProgressBar('capacity-bar', 'capacity-current', 'capacity-max', memberCount, 0, bedCount, '#009688');
            const capacityCurrentElem = document.getElementById('capacity-current');
            if (capacityCurrentElem) capacityCurrentElem.innerText = String(memberCount);
            const capacityMaxElem = document.getElementById('capacity-max');
            if (capacityMaxElem) capacityMaxElem.innerText = ' / ' + bedCount;

            const worldBackground = SafeGetValueWithFallback(characterData, [
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•ŒèƒŒæ™¯è®¾å®š',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.èƒŒæ™¯è®¾å®š',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•ŒèƒŒæ™¯'
            ], 'æš‚æ— ä¸–ç•ŒèƒŒæ™¯ä¿¡æ¯');
            const worldBackgroundElem = document.getElementById('world-background');
            if (worldBackgroundElem) {
                worldBackgroundElem.innerText = worldBackground && worldBackground !== 'N/A' && worldBackground !== '' ? worldBackground : 'æš‚æ— ä¸–ç•ŒèƒŒæ™¯ä¿¡æ¯';
            }

            const worldRules = SafeGetValueWithFallback(characterData, [
                'å½“å‰ä¸–ç•Œä¿¡æ¯.å½“å‰ä¸–ç•Œè§„åˆ™',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•Œè§„åˆ™',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.è§„åˆ™'
            ], 'æš‚æ— è§„åˆ™ä¿¡æ¯');
            const worldRulesElem = document.getElementById('world-rules');
            if (worldRulesElem) {
                worldRulesElem.innerText = worldRules && worldRules !== 'N/A' && worldRules !== '' ? worldRules : 'æš‚æ— è§„åˆ™ä¿¡æ¯';
            }

            const userPowerLevel = SafeGetValue(characterData, 'å½“å‰ä¸–ç•Œä¿¡æ¯.å½“å‰ä¸–ç•Œ{{user}}åŠ›é‡å±‚çº§', '');
            const userPowerLevelElem = document.getElementById('user-power-level');
            if (userPowerLevelElem) {
                if (userPowerLevel && userPowerLevel !== 'N/A' && userPowerLevel !== '') {
                    userPowerLevelElem.innerText = userPowerLevel;
                } else {
                    userPowerLevelElem.innerText = '-';
                }
            }

            const worldPowerSystem = SafeGetValueWithFallback(characterData, [
                'å½“å‰ä¸–ç•Œä¿¡æ¯.å½“å‰ä¸–ç•ŒåŠ›é‡ä½“ç³»',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.ä¸–ç•ŒåŠ›é‡ä½“ç³»',
                'å½“å‰ä¸–ç•Œä¿¡æ¯.åŠ›é‡ä½“ç³»'
            ], 'æš‚æ— åŠ›é‡ä½“ç³»ä¿¡æ¯');
            const worldPowerSystemElem = document.getElementById('world-power-system');
            if (worldPowerSystemElem) {
                if (worldPowerSystem && worldPowerSystem !== 'N/A' && worldPowerSystem !== '') {
                    worldPowerSystemElem.innerHTML = String(worldPowerSystem)
                        .replace(/\\n/g, '\n')
                        .replace(/\n/g, '<br>')
                        .replace(/ã€([^ã€‘]+)ã€‘/g, '<strong style="color: var(--primary);">ã€$1ã€‘</strong>');
                } else {
                    worldPowerSystemElem.innerText = 'æš‚æ— åŠ›é‡ä½“ç³»ä¿¡æ¯';
                }
            }

            const membersListElem = document.getElementById('members-list');
            if (membersListElem) {
                if (filteredMembers.length > 0) {
                    membersListElem.innerHTML = filteredMembers.map(m => {
                        if (typeof m === 'object' && m !== null) {
                            const name = m['å§“å'] || m['åç§°'] || 'æœªçŸ¥';
                            const identity = m['èº«ä»½'] || m['èŒä¸š'] || '';
                            const originWorld = m['åŸä¸–ç•Œ'] || '';
                            const residence = m['å±…ä½åŒº'] || '';
                            const relation = m['å…³ç³»'] || '';
                            const affection = m['å¥½æ„Ÿåº¦'];
                            const status = m['å½“å‰çŠ¶æ€'] || '';
                            
                            const portrait = m['äººç‰©ç”»åƒ'] || {};
                            const appearance = portrait['å¤–è²Œ'] || '';
                            const clothing = portrait['è¡£ç€'] || '';
                            const figure = portrait['èº«æ'] || '';
                            
                            const privacy = m['éšç§æ¡£æ¡ˆ'] || {};
                            const personality = privacy['æ€§æ ¼'] || '';
                            const preferences = privacy['å–œå¥½'] || '';
                            const gender = m['æ€§åˆ«'] || '';
                            const isVirgin = privacy['å¤„å¥³'];
                            const firstPartner = privacy['åˆæ¬¡å¯¹è±¡'] || '';
                            
                            const connections = m['äººè„‰'] || '';
                            
                            const abilities = m['èƒ½åŠ›é¢æ¿'] || {};
                            const attributes = abilities['å±æ€§'];
                            const talents = abilities['å¤©èµ‹'];
                            const skills = abilities['èƒ½åŠ›'];
                            
                            const equipment = m['è£…å¤‡æ '] || {};
                            const weapon = equipment['æ­¦å™¨'];
                            const armor = equipment['é˜²å…·'];
                            const accessory = equipment['é¥°å“'];
                            const backpack = m['èƒŒåŒ…'] || [];
                            
                            const hasPortrait = !!(appearance || clothing || figure);
                            const hasPrivacy = !!(personality || preferences || (isVirgin !== undefined) || firstPartner);
                            const hasConnections = !!(connections && connections.trim());
                            const hasAbilities = !!(attributes || talents || skills);
                            const hasEquipment = !!(weapon || armor || accessory || (backpack && Array.isArray(backpack) && backpack.length > 0));
                            const hasAnyDetails = hasPortrait || hasPrivacy || hasConnections || hasAbilities || hasEquipment;
                            
                            let html = '<div class="item-card" style="padding: 6px 8px;' + (hasAnyDetails ? ' cursor: pointer; position: relative;" onclick="toggleCardDetails(event, this)">' : '">');
                            html += '<div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; padding-right: 20px;">' + name;
                            if (hasAnyDetails) {
                                html += ' <span style="position: absolute; right: 8px; top: 6px; font-size: 0.7rem; color: var(--text-muted); transition: transform 0.2s;">â–¼</span>';
                            }
                            html += '</div>';
                            
                            let line1Parts = [];
                            if (originWorld) line1Parts.push('åŸä¸–ç•Œ: ' + originWorld);
                            if (residence) line1Parts.push('å±…ä½: ' + residence);
                            if (identity) line1Parts.push('èº«ä»½: ' + identity);
                            if (line1Parts.length > 0) {
                                html += '<div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 3px;">' + line1Parts.join(' | ') + '</div>';
                            }
                            
                            let line2Parts = [];
                            if (relation) line2Parts.push('å…³ç³»: ' + relation);
                            if (gender) line2Parts.push('æ€§åˆ«: ' + gender);
                            if (affection !== undefined && affection !== null) line2Parts.push('å¥½æ„Ÿåº¦: ' + affection);
                            if (status) line2Parts.push('çŠ¶æ€: ' + status);
                            if (line2Parts.length > 0) {
                                html += '<div style="font-size: 0.8rem; margin-bottom: 3px;">' + line2Parts.join(' | ') + '</div>';
                            }
                            
                            if (hasAnyDetails) {
                                html += '<div class="card-details" style="display: none; margin-top: 6px;">';
                                
                                html += '<div style="font-size: 0.82rem; margin-top: 5px; padding-left: 10px; border-left: 2px solid #e3e6f5;">';
                                html += '<div style="font-weight: 600; margin-bottom: 3px;">äººç‰©ç”»åƒ:</div>';
                                if (appearance) {
                                    html += '<div>å¤–è²Œ: ' + appearance + '</div>';
                                }
                                if (clothing) {
                                    html += '<div style="margin-top: 2px;">è¡£ç€: ' + clothing + '</div>';
                                }
                                if (figure) {
                                    html += '<div style="margin-top: 2px;">èº«æ: ' + figure + '</div>';
                                }
                                if (!appearance && !clothing && !figure) {
                                    html += '<div style="color: var(--text-muted); font-style: italic;">æœªè®¾ç½®</div>';
                                }
                                html += '</div>';
                                
                                html += '<div style="font-size: 0.82rem; margin-top: 5px; padding-left: 10px; border-left: 2px solid #e3e6f5;">';
                                html += '<div style="font-weight: 600; margin-bottom: 3px;">éšç§æ¡£æ¡ˆ:</div>';
                                if (personality) {
                                    html += '<div>æ€§æ ¼: ' + personality + '</div>';
                                }
                                if (preferences) {
                                    html += '<div style="margin-top: 2px;">å–œå¥½: ' + preferences + '</div>';
                                }
                                if (isVirgin !== undefined) {
                                    html += '<div style="margin-top: 2px;">å¤„å¥³: ' + (isVirgin ? 'æ˜¯' : 'å¦') + '</div>';
                                }
                                if (firstPartner) {
                                    html += '<div style="margin-top: 2px;">åˆæ¬¡å¯¹è±¡: ' + firstPartner + '</div>';
                                }
                                if (!personality && !preferences && isVirgin === undefined && !firstPartner) {
                                    html += '<div style="color: var(--text-muted); font-style: italic;">æœªè®¾ç½®</div>';
                                }
                                html += '</div>';
                                
                                // äººè„‰ï¼ˆå§‹ç»ˆæ˜¾ç¤ºæ ‡ç­¾ï¼‰
                                html += '<div style="font-size: 0.82rem; margin-top: 5px; padding-left: 10px; border-left: 2px solid #e3e6f5;">';
                                html += '<div style="font-weight: 600; margin-bottom: 3px;">äººè„‰:</div>';
                                if (connections && connections.trim()) {
                                    html += '<div>' + connections + '</div>';
                                } else {
                                    html += '<div style="color: var(--text-muted); font-style: italic;">æœªè®¾ç½®</div>';
                                }
                                html += '</div>';
                                
                                html += '<div style="font-size: 0.82rem; margin-top: 5px; padding-left: 10px; border-left: 2px solid #e3e6f5;">';
                                html += '<div style="font-weight: 600; margin-bottom: 3px;">èƒ½åŠ›é¢æ¿:</div>';
                                if (attributes) {
                                    const attrsStr = typeof attributes === 'string' ? attributes : (typeof attributes === 'object' ? JSON.stringify(attributes) : String(attributes));
                                    html += '<div>å±æ€§: ' + attrsStr + '</div>';
                                }
                                if (talents) {
                                    const talentsStr = typeof talents === 'string' ? talents : (Array.isArray(talents) ? talents.join(', ') : JSON.stringify(talents));
                                    html += '<div style="margin-top: 2px;">å¤©èµ‹: ' + talentsStr + '</div>';
                                }
                                if (skills) {
                                    const skillsStr = typeof skills === 'string' ? skills : (Array.isArray(skills) ? skills.join(', ') : JSON.stringify(skills));
                                    html += '<div style="margin-top: 2px;">èƒ½åŠ›: ' + skillsStr + '</div>';
                                }
                                if (!attributes && !talents && !skills) {
                                    html += '<div style="color: var(--text-muted); font-style: italic;">æœªè®¾ç½®</div>';
                                }
                                html += '</div>';
                                
                                html += '<div style="font-size: 0.82rem; margin-top: 5px; padding-left: 10px; border-left: 2px solid #e3e6f5;">';
                                html += '<div style="font-weight: 600; margin-bottom: 3px;">è£…å¤‡æ :</div>';
                                html += '<div style="font-size: 0.8rem; line-height: 1.5;">âš”ï¸ ' + formatEquipmentSimple(weapon) + ' | ğŸ›¡ï¸ ' + formatEquipmentSimple(armor) + ' | ğŸ’ ' + formatEquipmentSimple(accessory);
                                if (backpack && Array.isArray(backpack) && backpack.length > 0) {
                                    html += ' | ğŸ’ èƒŒåŒ…: ' + backpack.map(formatBackpackItemSimple).join(', ') + ' (' + backpack.length + '/3)';
                                } else {
                                    html += ' | ğŸ’ èƒŒåŒ…: ç©º (0/3)';
                                }
                                html += '</div>';
                                html += '</div>';
                                
                                html += '</div>'; // å…³é—­ card-details
                            }
                            html += '</div>'; // å…³é—­ item-card
                            return html;
                        }
                        return '';
                    }).join('');
                    
                    if (membersListElem.innerHTML.trim() === '') {
                        membersListElem.innerHTML = '<div class="empty-tip">æš‚æ— æˆå‘˜</div>';
                    }
                } else {
                    membersListElem.innerHTML = '<div class="empty-tip">æš‚æ— æˆå‘˜</div>';
                }
            }

            const localNpcsRaw = characterData['ä¸–ç•Œè§’è‰²å½•'] || [];
            const npcsElem = document.getElementById('local-npcs');
            if (npcsElem) {
                const localNpcs = Array.isArray(localNpcsRaw) ? localNpcsRaw : [];
                if (localNpcs.length > 0) {
                    npcsElem.innerHTML = localNpcs.map(n => {
                        if (typeof n === 'object' && n !== null) {
                            const name = n['å§“å'] || 'æœªçŸ¥';
                            const identity = n['èº«ä»½'] || '';
                            const relation = n['å…³ç³»'] || 'æœªçŸ¥';
                            const affection = n['å¥½æ„Ÿåº¦'] || 0;
                            const status = n['å½“å‰çŠ¶æ€'] || 'æœªçŸ¥';
                            
                            const portrait = n['äººç‰©ç”»åƒ'] || {};
                            const appearance = portrait['å¤–è²Œ'] || '';
                            const clothing = portrait['è¡£ç€'] || '';
                            const figure = portrait['èº«æ'] || '';
                            
                            const privacy = n['éšç§æ¡£æ¡ˆ'] || {};
                            const personality = privacy['æ€§æ ¼'] || '';
                            const preferences = privacy['å–œå¥½'] || '';
                            const gender = n['æ€§åˆ«'] || '';
                            const isVirgin = privacy['å¤„å¥³'];
                            const firstPartner = privacy['åˆæ¬¡å¯¹è±¡'] || '';
                            
                            const connections = n['äººè„‰'] || '';
                            
                            const abilities = n['èƒ½åŠ›é¢æ¿'] || {};
                            const attributes = abilities['å±æ€§'];
                            const talents = abilities['å¤©èµ‹'];
                            const skills = abilities['èƒ½åŠ›'];
                            
                            const equipment = n['è£…å¤‡æ '] || {};
                            const weapon = equipment['æ­¦å™¨'];
                            const armor = equipment['é˜²å…·'];
                            const accessory = equipment['é¥°å“'];
                            const backpack = n['èƒŒåŒ…'] || [];
                            
                            const hasPortraitNPC = !!(appearance || clothing || figure);
                            const hasPrivacyNPC = !!(personality || preferences || (isVirgin !== undefined) || firstPartner);
                            const hasConnectionsNPC = !!(connections && connections.trim());
                            const hasAbilitiesNPC = !!(attributes || talents || skills);
                            const hasEquipmentNPC = !!(weapon || armor || accessory || (backpack && Array.isArray(backpack) && backpack.length > 0));
                            const hasAnyDetailsNPC = hasPortraitNPC || hasPrivacyNPC || hasConnectionsNPC || hasAbilitiesNPC || hasEquipmentNPC;
                            
                            let html = '<div class="item-card" style="padding: 6px 8px;' + (hasAnyDetailsNPC ? ' cursor: pointer; position: relative;" onclick="toggleCardDetails(event, this)">' : '">');
                            html += '<div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 3px; padding-right: 20px;">' + name;
                            if (hasAnyDetailsNPC) {
                                html += ' <span style="position: absolute; right: 8px; top: 6px; font-size: 0.7rem; color: var(--text-muted); transition: transform 0.2s;">â–¼</span>';
                            }
                            html += '</div>';
                            html += '<div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 3px;">';
                            if (identity) {
                                html += 'èº«ä»½: ' + identity + ' | ';
                            }
                            html += 'å…³ç³»: ' + relation + ' | æ€§åˆ«: ' + (gender || 'æœªçŸ¥') + ' | å¥½æ„Ÿ: ' + affection + ' | çŠ¶æ€: ' + status + '</div>';
                            
                            if (hasAnyDetailsNPC) {
                                html += '<div class="card-details" style="display: none; margin-top: 6px;">';
                            
                                html += '<div style="font-size: 0.82rem; margin-top: 4px; padding-left: 10px; border-left: 2px solid #e3e6f5;">';
                                html += '<div style="font-weight: 600; margin-bottom: 2px;">äººç‰©ç”»åƒ:</div>';
                                if (appearance) {
                                    html += '<div>å¤–è²Œ: ' + appearance + '</div>';
                                }
                                if (clothing) {
                                    html += '<div style="margin-top: 2px;">è¡£ç€: ' + clothing + '</div>';
                                }
                                if (figure) {
                                    html += '<div style="margin-top: 2px;">èº«æ: ' + figure + '</div>';
                                }
                                if (!appearance && !clothing && !figure) {
                                    html += '<div style="color: var(--text-muted); font-style: italic;">æœªè®¾ç½®</div>';
                                }
                                html += '</div>';
                                
                                html += '<div style="font-size: 0.82rem; margin-top: 4px; padding-left: 10px; border-left: 2px solid #e3e6f5;">';
                                html += '<div style="font-weight: 600; margin-bottom: 2px;">éšç§æ¡£æ¡ˆ:</div>';
                                if (personality) {
                                    html += '<div>æ€§æ ¼: ' + personality + '</div>';
                                }
                                if (preferences) {
                                    html += '<div style="margin-top: 2px;">å–œå¥½: ' + preferences + '</div>';
                                }
                                if (isVirgin !== undefined) {
                                    html += '<div style="margin-top: 2px;">å¤„å¥³: ' + (isVirgin ? 'æ˜¯' : 'å¦') + '</div>';
                                }
                                if (firstPartner) {
                                    html += '<div style="margin-top: 2px;">åˆæ¬¡å¯¹è±¡: ' + firstPartner + '</div>';
                                }
                            if (!personality && !preferences && isVirgin === undefined && !firstPartner) {
                                html += '<div style="color: var(--text-muted); font-style: italic;">æœªè®¾ç½®</div>';
                            }
                            html += '</div>';
                            
                            // äººè„‰ï¼ˆå§‹ç»ˆæ˜¾ç¤ºæ ‡ç­¾ï¼‰
                            html += '<div style="font-size: 0.82rem; margin-top: 4px; padding-left: 10px; border-left: 2px solid #e3e6f5;">';
                            html += '<div style="font-weight: 600; margin-bottom: 2px;">äººè„‰:</div>';
                            if (connections && connections.trim()) {
                                html += '<div>' + connections + '</div>';
                            } else {
                                html += '<div style="color: var(--text-muted); font-style: italic;">æœªè®¾ç½®</div>';
                            }
                            html += '</div>';
                            
                            html += '<div style="font-size: 0.82rem; margin-top: 4px; padding-left: 10px; border-left: 2px solid #e3e6f5;">';
                            html += '<div style="font-weight: 600; margin-bottom: 2px;">èƒ½åŠ›é¢æ¿:</div>';
                                if (attributes) {
                                    const attrsStr = typeof attributes === 'string' ? attributes : (typeof attributes === 'object' ? JSON.stringify(attributes) : String(attributes));
                                    html += '<div>å±æ€§: ' + attrsStr + '</div>';
                                }
                                if (talents) {
                                    const talentsStr = typeof talents === 'string' ? talents : (Array.isArray(talents) ? talents.join(', ') : JSON.stringify(talents));
                                    html += '<div style="margin-top: 2px;">å¤©èµ‹: ' + talentsStr + '</div>';
                                }
                                if (skills) {
                                    const skillsStr = typeof skills === 'string' ? skills : (Array.isArray(skills) ? skills.join(', ') : JSON.stringify(skills));
                                    html += '<div style="margin-top: 2px;">èƒ½åŠ›: ' + skillsStr + '</div>';
                                }
                                if (!attributes && !talents && !skills) {
                                    html += '<div style="color: var(--text-muted); font-style: italic;">æœªè®¾ç½®</div>';
                                }
                                html += '</div>';
                                
                                html += '<div style="font-size: 0.82rem; margin-top: 4px; padding-left: 10px; border-left: 2px solid #e3e6f5;">';
                                html += '<div style="font-weight: 600; margin-bottom: 2px;">è£…å¤‡æ :</div>';
                                html += '<div style="font-size: 0.8rem; line-height: 1.5;">âš”ï¸ ' + formatEquipmentSimple(weapon) + ' | ğŸ›¡ï¸ ' + formatEquipmentSimple(armor) + ' | ğŸ’ ' + formatEquipmentSimple(accessory);
                                if (backpack && Array.isArray(backpack) && backpack.length > 0) {
                                    html += ' | ğŸ’ èƒŒåŒ…: ' + backpack.map(formatBackpackItemSimple).join(', ') + ' (' + backpack.length + '/3)';
                                } else {
                                    html += ' | ğŸ’ èƒŒåŒ…: ç©º (0/3)';
                                }
                                html += '</div>';
                                html += '</div>';
                                
                                html += '</div>'; // å…³é—­ card-details
                            }
                            html += '</div>'; // å…³é—­ item-card
                            return html;
                        }
                        return '';
                    }).join('');
                    
                    if (npcsElem.innerHTML.trim() === '') {
                        npcsElem.innerHTML = '<div class="empty-tip">æš‚æ— è®°å½•</div>';
                    }
                } else {
                    npcsElem.innerHTML = '<div class="empty-tip">æš‚æ— è®°å½•</div>';
                }
            }

            const factionsRaw = characterData['ä¸–ç•ŒåŠ¿åŠ›æ¡£æ¡ˆ'] || [];
            const factionsElem = document.getElementById('world-factions');
            if (factionsElem) {
                const factions = Array.isArray(factionsRaw) ? factionsRaw : [];
                if (factions.length > 0) {
                    factionsElem.innerHTML = factions.map(f => {
                        if (typeof f === 'object' && f !== null) {
                            const name = f['åŠ¿åŠ›åç§°'] || f['åç§°'] || 'æœªçŸ¥åŠ¿åŠ›';
                            const type = f['ç±»å‹'] || 'æœªçŸ¥';
                            const location = f['åœ°ç†ä½ç½®'] || 'æœªçŸ¥';
                            const leader = f['é¢†å¯¼è€…'] && typeof f['é¢†å¯¼è€…'] === 'object' ? (f['é¢†å¯¼è€…']['å§“å'] || '') : (typeof f['é¢†å¯¼è€…'] === 'string' ? f['é¢†å¯¼è€…'] : 'æœªçŸ¥');
                            const attitude = f['å¯¹ä¸»è§’æ€åº¦'] || 'æœªçŸ¥';
                            const currentState = f['å½“å‰çŠ¶æ€'] || 'æœªçŸ¥';
                            const resources = f['èµ„æºå‚¨å¤‡'] || '';
                            
                            let html = '<div class="item-card" style="padding: 10px 12px;">';
                            html += '<div style="font-weight: 600; margin-bottom: 5px;">' + name + ' [' + type + ']</div>';
                            html += '<div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">ä½ç½®: ' + location + ' | é¢†å¯¼è€…: ' + leader + '</div>';
                            html += '<div style="font-size: 0.85rem; margin-bottom: 4px;">å¯¹ä¸»è§’æ€åº¦: ' + attitude + ' | å½“å‰çŠ¶æ€: ' + currentState + '</div>';
                            if (resources) {
                                html += '<div style="font-size: 0.82rem; margin-top: 4px; padding-left: 10px; border-left: 2px solid #e3e6f5;">èµ„æº: ' + (typeof resources === 'string' ? resources : JSON.stringify(resources)) + '</div>';
                            }
                            html += '</div>';
                            return html;
                        }
                        return '';
                    }).join('');
                    
                    if (factionsElem.innerHTML.trim() === '') {
                        factionsElem.innerHTML = '<div class="empty-tip">æš‚æ— æƒ…æŠ¥</div>';
                    }
                } else {
                    factionsElem.innerHTML = '<div class="empty-tip">æš‚æ— æƒ…æŠ¥</div>';
                }
            }

            const destinyListRaw = characterData['ä¸–ç•Œå‘½è¿æ¸…å•'] || [];
            const missionsListElem = document.getElementById('missions-list');
            if (missionsListElem) {
                if (Array.isArray(destinyListRaw) && destinyListRaw.length > 0) {
                    let destinyHtml = '';
                    destinyListRaw.forEach((destinyLine, idx) => {
                        const lineName = SafeGetValue(destinyLine, 'å‘½è¿çº¿åç§°', 'æœªçŸ¥å‘½è¿çº¿');
                        const lineLevel = SafeGetValue(destinyLine, 'ç­‰çº§', 'æœªçŸ¥');
                        const lineBg = SafeGetValue(destinyLine, 'å‘½è¿èƒŒæ™¯', '');
                        let lineNodes = [];
                        const nodesRaw = destinyLine['å‘½è¿èŠ‚ç‚¹'];
                        if (nodesRaw) {
                            if (Array.isArray(nodesRaw)) {
                                lineNodes = nodesRaw;
                            } else if (typeof nodesRaw === 'object' && nodesRaw !== null) {
                                lineNodes = [nodesRaw];
                            }
                        }
                        const totalOriginRaw = SafeGetValue(destinyLine, 'æœ¬æºæ¡†æ¶', 0);
                        let totalOrigin = parseFloat(String(totalOriginRaw).replace(/[^0-9.-]/g, '')) || 0;
                        
                        let typeClass = 'task-type-simple';
                        let completedColor = '#4ecdc4';
                        if (lineLevel === 'å›°éš¾') {
                            typeClass = 'task-type-hard';
                            completedColor = '#ff9800';
                        } else if (lineLevel === 'æé™') {
                            typeClass = 'task-type-extreme';
                            completedColor = '#f44336';
                        }
                        
                        let allCompleted = false;
                        let hasFailed = false;
                        let completedCount = 0;
                        let obtainedOrigin = 0;
                        let allNodesResolved = false;
                        
                        const badgeColor = '#4caf50';
                        
                        if (Array.isArray(lineNodes) && lineNodes.length > 0) {
                            let resolvedCount = 0;
                            lineNodes.forEach((node, nodeIdx) => {
                                let nodeStatus = 'æœªåè½¬';
                                
                                if (typeof node === 'string') {
                                    const nodeStr = String(node);
                                    if (nodeStr.startsWith('âœ“ ')) {
                                        nodeStatus = 'å·²åè½¬';
                                    } else if (nodeStr.startsWith('âœ— ')) {
                                        nodeStatus = 'å·²å¤±è´¥';
                                    }
                                } else if (typeof node === 'object' && node !== null) {
                                    nodeStatus = SafeGetValue(node, 'çŠ¶æ€', 'æœªåè½¬');
                                }
                                
                                if (nodeStatus === 'å·²åè½¬') {
                                    completedCount++;
                                    const nodeOriginRaw = typeof node === 'object' && node !== null ? SafeGetValue(node, 'è·å¾—æœ¬æº', 0) : 0;
                                    const nodeOrigin = parseFloat(String(nodeOriginRaw).replace(/[^0-9.-]/g, '')) || 0;
                                    obtainedOrigin += nodeOrigin;
                                    resolvedCount++;
                                }
                                if (nodeStatus === 'å·²å¤±è´¥') {
                                    hasFailed = true;
                                    resolvedCount++;
                                }
                            });
                            
                            allCompleted = completedCount === lineNodes.length && !hasFailed;
                            allNodesResolved = resolvedCount === lineNodes.length;
                        } else if (lineNodes && lineNodes.length === 0) {
                            allNodesResolved = false;
                        }
                        
                        const isEnded = allNodesResolved;
                        const isFinished = allCompleted;
                        
                        destinyHtml += '<div class="task-item destiny-line-item" style="position: relative; cursor: pointer; ' + (isEnded ? 'opacity: 0.6; background: #f9f9f9;' : '') + '" onclick="toggleDestinyLine(event, this)">';
                        destinyHtml += '<div class="task-header">';
                        destinyHtml += '<span class="task-type ' + typeClass + '">' + lineLevel + '</span>';
                        destinyHtml += '<span class="task-name">' + lineName + '</span>';
                        destinyHtml += '<span class="destiny-line-arrow" style="position: absolute; top: 8px; right: 8px; font-size: 0.7rem; color: var(--text-muted); transition: transform 0.2s;">â–¼</span>';
                        if (isFinished) {
                            destinyHtml += '<span style="position: absolute; top: 8px; right: 24px; padding: 4px 12px; background: ' + badgeColor + '; color: white; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">âœ“ å·²å®Œæˆ</span>';
                        } else if (isEnded) {
                            destinyHtml += '<span style="position: absolute; top: 8px; right: 24px; padding: 4px 12px; background: #999; color: white; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">å·²ç»“æŸ</span>';
                        } else {
                            destinyHtml += '<span style="position: absolute; top: 8px; right: 24px; padding: 4px 12px; background: transparent; color: ' + badgeColor + '; border: 1.5px solid ' + badgeColor + '; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">è¿›è¡Œä¸­</span>';
                        }
                        destinyHtml += '</div>';
                        
                        destinyHtml += '<div class="destiny-line-details" style="display: none; margin-top: 8px;">';
                        
                        if (lineBg) {
                            destinyHtml += '<p class="task-desc" style="margin-top: 8px;">' + lineBg + '</p>';
                        }
                        
                        if (Array.isArray(lineNodes) && lineNodes.length > 0) {
                            destinyHtml += '<div style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.03); border-radius: 6px;">';
                            destinyHtml += '<div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: var(--text-muted);">å‘½è¿èŠ‚ç‚¹:</div>';
                            
                            lineNodes.forEach((node, nodeIdx) => {
                                let nodeDesc = 'æœªçŸ¥èŠ‚ç‚¹';
                                let nodeStatus = 'æœªåè½¬';
                                let nodeEvaluation = '';
                                let nodeOrigin = 0;
                                let failReason = '';
                                
                                if (typeof node === 'string') {
                                    const nodeStr = String(node);
                                    if (nodeStr.startsWith('âœ“ ')) {
                                        nodeStatus = 'å·²åè½¬';
                                        nodeDesc = nodeStr.substring(2);
                                    } else if (nodeStr.startsWith('âœ— ')) {
                                        nodeStatus = 'å·²å¤±è´¥';
                                        nodeDesc = nodeStr.substring(2);
                                    } else {
                                        nodeDesc = nodeStr.startsWith('â–¡ ') ? nodeStr.substring(2) : nodeStr;
                                    }
                                } else if (typeof node === 'object' && node !== null) {
                                    nodeDesc = SafeGetValue(node, 'æè¿°', 'æœªçŸ¥èŠ‚ç‚¹');
                                    nodeStatus = SafeGetValue(node, 'çŠ¶æ€', 'æœªåè½¬');
                                    nodeEvaluation = SafeGetValue(node, 'åè½¬è¯„ä»·', '');
                                    const nodeOriginRaw = SafeGetValue(node, 'è·å¾—æœ¬æº', 0);
                                    nodeOrigin = parseFloat(String(nodeOriginRaw).replace(/[^0-9.-]/g, '')) || 0;
                                    failReason = SafeGetValue(node, 'å¤±è´¥åŸå› ', '');
                                }
                                
                                const isCompleted = nodeStatus === 'å·²åè½¬';
                                const isFailed = nodeStatus === 'å·²å¤±è´¥';
                                
                                destinyHtml += '<div style="margin-bottom: 8px;">';
                                
                                let nodeStyle = 'font-size: 0.9rem;';
                                let nodeIcon = 'â–¡ ';
                                
                                if (isCompleted) {
                                    nodeStyle += 'text-decoration: line-through; color: ' + completedColor + ';';
                                    nodeIcon = 'âœ“ ';
                                } else if (isFailed) {
                                    nodeStyle += 'text-decoration: line-through; color: #999; opacity: 0.7;';
                                    nodeIcon = 'âœ— ';
                                }
                                
                                destinyHtml += '<div style="' + nodeStyle + '">';
                                destinyHtml += nodeIcon + nodeDesc;
                                destinyHtml += '</div>';
                                
                                if (isCompleted && (nodeEvaluation || nodeOrigin > 0)) {
                                    destinyHtml += '<div style="margin-top: 4px; margin-left: 20px; padding: 4px 8px; background: rgba(78, 205, 196, 0.1); border-left: 2px solid ' + completedColor + '; border-radius: 4px; font-size: 0.82rem;">';
                                    if (nodeEvaluation && nodeEvaluation !== 'N/A' && nodeEvaluation !== '') {
                                        destinyHtml += '<span style="color: var(--text-muted);">åè½¬è¯„ä»·: </span>';
                                        destinyHtml += '<span style="color: ' + completedColor + '; font-weight: 600;">' + nodeEvaluation + '</span>';
                                    }
                                    if (nodeOrigin > 0) {
                                        if (nodeEvaluation && nodeEvaluation !== 'N/A' && nodeEvaluation !== '') {
                                            destinyHtml += ' <span style="color: var(--text-muted);">|</span> ';
                                        }
                                        destinyHtml += '<span style="color: var(--text-muted);">è·å¾—æœ¬æº: </span>';
                                        destinyHtml += '<span style="color: var(--accent-teal); font-weight: 600;">+' + nodeOrigin + ' pts</span>';
                                    }
                                    destinyHtml += '</div>';
                                }
                                
                                if (isFailed && failReason && failReason !== 'N/A' && failReason !== '') {
                                    destinyHtml += '<div style="margin-top: 4px; margin-left: 20px; padding: 4px 8px; background: rgba(0,0,0,0.03); border-left: 2px solid #999; border-radius: 4px; font-size: 0.82rem; color: #666;">';
                                    destinyHtml += '<span style="color: var(--text-muted);">å¤±è´¥åŸå› : </span>';
                                    destinyHtml += '<span style="font-style: italic;">' + failReason + '</span>';
                                    destinyHtml += '</div>';
                                }
                                
                                destinyHtml += '</div>';
                            });
                            
                            destinyHtml += '</div>';
                        } else if (lineNodes && lineNodes.length === 0) {
                            destinyHtml += '<div style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.03); border-radius: 6px;">';
                            destinyHtml += '<div style="font-size: 0.85rem; color: var(--text-muted);">æš‚æ— å‘½è¿èŠ‚ç‚¹</div>';
                            destinyHtml += '</div>';
                        }
                        
                        const originPercentage = totalOrigin > 0 ? Math.min(100, (obtainedOrigin / totalOrigin) * 100) : 0;
                        const isLocked = allNodesResolved;
                        destinyHtml += '<div class="metric-card" style="margin-top: 8px; ' + (isLocked ? 'opacity: 0.6; background: #f5f5f5;' : '') + '">';
                        destinyHtml += '<div class="metric-header">';
                        destinyHtml += '<span class="metric-label">' + (isLocked ? 'ğŸ”’ ' : 'ğŸ’ ') + 'æœ¬æºè¿›åº¦</span>';
                        destinyHtml += '<span class="metric-value">';
                        destinyHtml += '<span style="color: ' + (isLocked ? '#999' : 'var(--accent-teal)') + ';">' + Math.floor(totalOrigin) + '</span>';
                        destinyHtml += '<span class="metric-desc" style="color: var(--text-muted);"> pts</span>';
                        destinyHtml += '</span>';
                        destinyHtml += '</div>';
                        destinyHtml += '<div class="progress-bar-container">';
                        destinyHtml += '<div class="progress-bar-value" style="width: ' + originPercentage + '%; background-color: ' + (isLocked ? '#999' : 'var(--accent-teal)') + ';"></div>';
                        destinyHtml += '</div>';
                        destinyHtml += '</div>';
                        
                        destinyHtml += '</div>';
                        destinyHtml += '</div>';
                    });
                    
                    missionsListElem.innerHTML = destinyHtml || '<div class="empty-tip">æš‚æ— å‘½è¿çº¿</div>';
                } else {
                    missionsListElem.innerHTML = '<div class="empty-tip">æš‚æ— å‘½è¿çº¿</div>';
                }
            }

            const inventoryRaw = characterData['ä»“åº“æ¸…å•'] || [];
            const inventoryListElem = document.getElementById('inventory-list');
            if (inventoryListElem) {
                if (Array.isArray(inventoryRaw) && inventoryRaw.length > 0) {
                    inventoryListElem.innerHTML = inventoryRaw.map(i => {
                        if (typeof i === 'object' && i !== null) {
                            const name = i['åç§°'] || i['name'] || 'æœªçŸ¥ç‰©å“';
                            const type = i['ç±»å‹'] || i['type'] || 'å…¶ä»–';
                            const count = i['æ•°é‡'] || i['count'] || 1;
                            const value = i['ä»·å€¼'] || i['value'] || 0;
                            const originEnergy = i['æœ¬æºèƒ½é‡'] || i['originEnergy'] || 0;
                            const desc = i['æè¿°'] || i['description'] || '';
                            const effects = i['æ•ˆæœ'] || i['effects'] || '';
                            
                            let html = '<div class="item-card" style="padding: 5px 7px;">';
                            html += '<div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 3px;">' + name + ' <span style="color: var(--text-muted); font-weight: 400; font-size: 0.8rem;">x' + count + '</span></div>';
                            html += '<div style="font-size: 0.75rem; margin-bottom: 3px;">';
                            html += '<span style="display: inline-block; padding: 1px 5px; background: rgba(79, 110, 247, 0.1); border-radius: 3px; margin-right: 5px; font-size: 0.72rem;">ğŸ·ï¸ ' + type + '</span>';
                            if (value > 0) {
                                html += '<span style="display: inline-block; padding: 1px 5px; background: rgba(78, 205, 196, 0.15); border-radius: 3px; margin-right: 5px; font-size: 0.72rem; color: var(--accent-teal); font-weight: 600;">ğŸ’° ' + value + '</span>';
                            }
                            if (originEnergy > 0) {
                                html += '<span style="display: inline-block; padding: 1px 5px; background: rgba(255, 107, 157, 0.15); border-radius: 3px; font-size: 0.72rem; color: var(--accent-rose); font-weight: 600;">ğŸ’ ' + originEnergy + ' pts</span>';
                            }
                            html += '</div>';
                            if (desc) {
                                html += '<div style="font-size: 0.78rem; margin-top: 4px; color: var(--text-muted); padding-left: 8px; border-left: 2px solid #e3e6f5; line-height: 1.3;">ğŸ“ ' + desc + '</div>';
                            }
                            if (effects) {
                                html += '<div style="font-size: 0.78rem; margin-top: 3px; color: var(--accent-rose); padding-left: 8px; border-left: 2px solid #e3e6f5; line-height: 1.3;">âš¡ ' + (typeof effects === 'string' ? effects : JSON.stringify(effects)) + '</div>';
                            }
                            html += '</div>';
                            return html;
                        }
                        return '';
                    }).join('');
                    
                    if (inventoryListElem.innerHTML.trim() === '') {
                        inventoryListElem.innerHTML = '<div class="empty-tip">ä»“åº“ä¸ºç©º</div>';
                    }
                } else {
                    inventoryListElem.innerHTML = '<div class="empty-tip">ä»“åº“ä¸ºç©º</div>';
                }
            }
        } catch (error) {
            document.getElementById('status-card').innerHTML = '<div class="error-tip">çŠ¶æ€æ åŠ è½½å‡ºé”™: ' + error.message + '</div>';
        }
    }

    // --- UI äº¤äº’å‡½æ•° ---

    function switchTab(tabName, tabElement) {
        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-panel');
        const clickedTab = tabElement || document.querySelector('[data-tab="' + tabName + '"]');
        const targetPanel = document.getElementById('tab-content-' + tabName);
        
        if (!targetPanel) return;
        
        const isCurrentlyActive = clickedTab && clickedTab.classList.contains('active');
        
        tabs.forEach(tab => tab.classList.remove('active'));
        contents.forEach(content => content.classList.remove('active'));
        
        if (isCurrentlyActive) {
            clickedTab.classList.remove('active');
            targetPanel.classList.remove('active');
        } else {
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            targetPanel.classList.add('active');
        }
    }

    function toggleTheme() {
        const root = document.documentElement;
        const currentTheme = root.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        root.setAttribute('data-theme', newTheme);
        localStorage.setItem('statusBarTheme', newTheme);
        
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            themeToggle.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }
    }

    function initTheme() {
        const savedTheme = localStorage.getItem('statusBarTheme') || 'light';
        const root = document.documentElement;
        root.setAttribute('data-theme', savedTheme);
        
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            themeToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }
    }

    function toggleCardDetails(event, cardElement) {
        event.stopPropagation();
        
        const detailsDiv = cardElement.querySelector('.card-details');
        if (!detailsDiv) return;
        
        const isCurrentlyOpen = detailsDiv.style.display !== 'none';
        const arrow = cardElement.querySelector('span[style*="transition"]');
        
        document.querySelectorAll('.card-details').forEach(details => {
            details.style.display = 'none';
        });
        document.querySelectorAll('.item-card').forEach(card => {
            card.classList.remove('expanded');
            const otherArrow = card.querySelector('span[style*="transition"]');
            if (otherArrow) {
                otherArrow.style.transform = 'rotate(0deg)';
            }
        });
        
        if (!isCurrentlyOpen) {
            detailsDiv.style.display = 'block';
            cardElement.classList.add('expanded');
            if (arrow) {
                arrow.style.transform = 'rotate(180deg)';
            }
        }
    }

    function toggleDestinyLine(event, lineElement) {
        event.stopPropagation();
        
        const detailsDiv = lineElement.querySelector('.destiny-line-details');
        if (!detailsDiv) return;
        
        const isCurrentlyOpen = detailsDiv.style.display !== 'none';
        const arrow = lineElement.querySelector('.destiny-line-arrow');
        
        document.querySelectorAll('.destiny-line-details').forEach(details => {
            details.style.display = 'none';
        });
        document.querySelectorAll('.destiny-line-item').forEach(item => {
            const otherArrow = item.querySelector('.destiny-line-arrow');
            if (otherArrow) {
                otherArrow.style.transform = 'rotate(0deg)';
            }
        });
        
        if (!isCurrentlyOpen) {
            detailsDiv.style.display = 'block';
            if (arrow) {
                arrow.style.transform = 'rotate(180deg)';
            }
        }
    }

    // --- äº‹ä»¶ç›‘å¬ä¸åˆå§‹åŒ– ---

    document.addEventListener('click', function(event) {
        if (!event.target.closest('.item-card')) {
            document.querySelectorAll('.card-details').forEach(details => {
                details.style.display = 'none';
            });
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('expanded');
                const arrow = card.querySelector('span[style*="transition"]');
                if (arrow) {
                    arrow.style.transform = 'rotate(0deg)';
                }
            });
        }
        if (!event.target.closest('.destiny-line-item')) {
            document.querySelectorAll('.destiny-line-details').forEach(details => {
                details.style.display = 'none';
            });
            document.querySelectorAll('.destiny-line-item').forEach(item => {
                const arrow = item.querySelector('.destiny-line-arrow');
                if (arrow) {
                    arrow.style.transform = 'rotate(0deg)';
                }
            });
        }
    });

    document.addEventListener('click', function(event) {
        const statusCard = document.getElementById('status-card');
        if (!statusCard) return;
        
        if (!statusCard.contains(event.target)) {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-panel');
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
        }
    });

    (function() {
        initTheme();
        initDisplay();
    })();

</script>
</body>
</html>
```
